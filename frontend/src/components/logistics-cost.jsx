"use client"

import { useEffect, useState } from "react"
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card"
import { Badge } from "@/components/ui/badge"
import { Separator } from "@/components/ui/separator"
import { Calculator, Truck, MapPin, Calendar, Hash, Weight, DollarSign, FileText, Clock, Package } from "lucide-react"
import { format } from "date-fns"
import { getAppointmentCharges, getCourierType, getDocketCharges } from "@/constants/courier-partners"
import { getSkuOrdersByShipment } from "@/lib/order"
import { master_channel_location_mapping } from "@/constants/master_sheet"

const FACILITY_PICKUP_MAPPING = {
  HYP_SRGWHT: "Guwahati",
  HYP_SRBGLR: "Bangalore",
  HYP_SRHYD: "Hyderabad",
  HYP_SRKOL: "Kolkata",
  mCaff_Ahmedabad: "Ahmedabad",
  mCaff_Kolkata2: "Kolkata",
  mCaff_Guwahati: "Guwahati",
  mCaff_Hyderabad2: "Hyderabad",
  mCaff_Bangalore2: "Bangalore",
  mCaff_Gurgaon2: "Gurgaon",
  mCaff_Mumbai2: "Mumbai",
  HYP_SRGGN: "Gurgaon",
  HYP_AHMD: "Ahmedabad",
  HYP_B2B_MUM2: "Mumbai",
  MUM_Warehouse2: "Mumbai",
}

const RATE_PER_KG_MAPPING = {
  "Channel A": 45.5,
  "Channel B": 52.0,
  "Channel C": 38.75,
  Default: 42.0,
}

const COURIER_DOCKET_CHARGES = {
  "Courier A": 25.0,
  "Courier B": 30.0,
  "Courier C": 20.0,
  Default: 25.0,
}

const APPOINTMENT_CHARGES_MAPPING = {
  "Channel A": {
    "Courier A": 50.0,
    "Courier B": 45.0,
    Default: 40.0,
  },
  "Channel B": {
    "Courier A": 60.0,
    "Courier B": 55.0,
    Default: 50.0,
  },
  Default: {
    Default: 45.0,
  },
}

export default function LogisticsCost({ shipmentData }) {
  const [isFetching, setFetching] = useState(true)
  const [skus, setSkus] = useState([])
  const [calculations, setCalculations] = useState(null)
  const [basicInfo, setBasic] = useState({})
  const [costs, setCosts] = useState({})
  const [error, setError] = useState("")

  const calculateCosts = (shipmentData, skuData) => {
    if (!shipmentData) return null

    const totalUpdatedPoValue = () => {
      let val = 0
      if (!skuData || skuData.length === 0) return 0
      skuData.forEach((element) => {
        val += element.updatedPoValue || 0
      })
      return val
    }

    // Basic info extraction
    const uid = shipmentData.uid || "N/A"
    const entryDate = shipmentData?.entryDate || null
    const poDate = shipmentData?.poDate || null
    const channel = shipmentData?.channel || "Default"
    const location = shipmentData?.location || "N/A"
    const facility = shipmentData?.facility || "Default"
    const poNumber = shipmentData?.poNumber || "N/A"
    const chargeableWeight = Number.parseFloat(shipmentData.chargeableWeight || shipmentData.physicalWeight || shipmentData.actualWeight) || 0
    const updatedPoValue = totalUpdatedPoValue() || 0
    const firstTransporter = shipmentData.firstTransporter || null
    const secondTransporter = shipmentData.secondTransporter || null
    const thirdTransporter = shipmentData.thirdTransporter || null

    // Get mapped values
    const pickupLocation = FACILITY_PICKUP_MAPPING[facility] || FACILITY_PICKUP_MAPPING["Default"] || "Unknown"
    const courierType = getCourierType(firstTransporter)
    const ratePerKg = RATE_PER_KG_MAPPING[channel] || RATE_PER_KG_MAPPING["Default"] || 65

    // Cost calculations
    const frightCost = chargeableWeight * ratePerKg

    // Final FOV calculation based on courier type
    let finalFov = 0
    switch (courierType) {
      case "Type A":
        finalFov = Math.max(updatedPoValue * 0.001, 100)
        break
      case "Type B":
        finalFov = 100
        break
      case "Type C":
        finalFov = 0
        break
      default:
        finalFov = 0
    }

    // Docket charges
    let docketCharges = 0
    if (firstTransporter) docketCharges += getDocketCharges(firstTransporter)
    if (secondTransporter) docketCharges += getDocketCharges(secondTransporter)
    if (thirdTransporter) docketCharges += getDocketCharges(thirdTransporter)

    // Appointment charges
    const apptChannel = master_channel_location_mapping[channel] ? master_channel_location_mapping[channel][0]["apptChannel"] : "no";
    const appointmentCharges = getAppointmentCharges(firstTransporter, apptChannel);
      // APPOINTMENT_CHARGES_MAPPING[channel]?.[firstTransporter] ||
      // APPOINTMENT_CHARGES_MAPPING[channel]?.["Default"] ||
      // APPOINTMENT_CHARGES_MAPPING["Default"]["Default"]

    // Misc charges
    const MISC_CHARGES = {
      "Delivery Charges": shipmentData.deliveryCharges ?? 0,
      "Halting": shipmentData.halting ?? 0,
      "Unloading Charges": shipmentData.unloadingCharges ?? 0,
      "Dedicated Vehicle": shipmentData.dedicatedVehicle ?? 0,
      "Other Charges": shipmentData.otherCharges ?? 0,
    }
    const miscCharges = Object.values(MISC_CHARGES)
    const totalMiscCharges = miscCharges.reduce((sum, charge) => sum + charge, 0)

    // Total cost
    const totalCost = frightCost + finalFov + docketCharges + appointmentCharges + totalMiscCharges

    return {
      basicInfo: {
        uid,
        entryDate,
        poDate,
        channel,
        location,
        pickupLocation,
        poNumber,
        chargeableWeight,
        ratePerKg,
        courierType,
        firstTransporter,
        updatedPoValue,
      },
      costs: {
        frightCost,
        finalFov,
        docketCharges,
        appointmentCharges,
        miscCharges: MISC_CHARGES,
        totalMiscCharges,
        totalCost,
      },
    }
  }

  const getSkuData = async () => {
    if (!shipmentData) {
      setFetching(false)
      return
    }

    try {
      setFetching(true)
      setError("")

      const res = await getSkuOrdersByShipment(shipmentData.uid)
      console.log("SKU Data Response:", res.data)

      const skuData = res.data?.skus || []
      setSkus(skuData)

      // Calculate costs after fetching SKU data
      const calculationResult = calculateCosts(shipmentData, skuData)

      if (calculationResult) {
        setCalculations(calculationResult)
        setBasic(calculationResult.basicInfo)
        setCosts(calculationResult.costs)
      }
    } catch (error) {
      console.error("Error fetching SKU data:", error)
      setError("Failed to fetch SKU data: " + (error.message || error))
      setSkus([])
      setCalculations(null)
    } finally {
      setFetching(false)
    }
  }

  useEffect(() => {
    getSkuData()
  }, [shipmentData])

  if (isFetching) {
    return (
      <div className="flex items-center justify-center h-64">
        <div className="text-center">
          <Calculator className="h-12 w-12 text-blue-500 mx-auto mb-4 animate-spin" />
          <p className="text-gray-600 font-medium">Loading SKU data and calculating costs...</p>
          <p className="text-sm text-gray-500 mt-2">Please wait while we fetch the shipment details</p>
        </div>
      </div>
    )
  }

  if (error) {
    return (
      <div className="flex items-center justify-center h-64">
        <div className="text-center">
          <Calculator className="h-12 w-12 text-red-400 mx-auto mb-4" />
          <p className="text-red-600 font-medium">Error loading data</p>
          <p className="text-sm text-red-500 mt-2">{error}</p>
          <button
            onClick={getSkuData}
            className="mt-4 px-4 py-2 bg-red-100 text-red-700 rounded-lg hover:bg-red-200 transition-colors"
          >
            Retry
          </button>
        </div>
      </div>
    )
  }

  if (!calculations) {
    return (
      <div className="flex items-center justify-center h-64">
        <div className="text-center">
          <Calculator className="h-12 w-12 text-gray-400 mx-auto mb-4" />
          <p className="text-gray-500">No shipment data available for cost calculation</p>
          <p className="text-sm text-gray-400 mt-2">Please select a valid shipment to view logistics costs</p>
        </div>
      </div>
    )
  }

  return (
    <div className="space-y-6">
      {/* Debug Info */}
      <Card className="border-blue-200 bg-blue-50 dark:border-blue-800 dark:bg-blue-950">
        <CardHeader>
          <CardTitle className="text-sm text-blue-900 dark:text-blue-100">Debug Information</CardTitle>
        </CardHeader>
        <CardContent>
          <div className="text-xs space-y-1">
            <p>
              <strong>SKUs Found:</strong> {skus.length}
            </p>
            <p>
              <strong>Total Updated PO Value:</strong> â‚¹{basicInfo.updatedPoValue?.toFixed(2) || "0.00"}
            </p>
            <p>
              <strong>Shipment UID:</strong> {shipmentData?.uid || "N/A"}
            </p>
          </div>
        </CardContent>
      </Card>

      {/* Basic Shipment Information */}
      <Card>
        <CardHeader>
          <CardTitle className="flex items-center gap-2">
            <FileText className="h-5 w-5" />
            Basic Shipment Information
          </CardTitle>
        </CardHeader>
        <CardContent>
          <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            <div className="space-y-1">
              <div className="flex items-center gap-2 text-sm text-gray-500">
                <Hash className="h-4 w-4" />
                Shipment UID
              </div>
              <div className="font-mono text-sm bg-gray-100 dark:bg-gray-800 p-2 rounded">{basicInfo.uid}</div>
            </div>

            <div className="space-y-1">
              <div className="flex items-center gap-2 text-sm text-gray-500">
                <Calendar className="h-4 w-4" />
                Entry Date
              </div>
              <div className="text-sm">
                {basicInfo.entryDate
                  ? typeof basicInfo.entryDate === "string"
                    ? basicInfo.entryDate
                    : format(new Date(basicInfo.entryDate), "dd MMM yyyy")
                  : "N/A"}
              </div>
            </div>

            <div className="space-y-1">
              <div className="flex items-center gap-2 text-sm text-gray-500">
                <Calendar className="h-4 w-4" />
                PO Date
              </div>
              <div className="text-sm">
                {basicInfo.poDate
                  ? typeof basicInfo.poDate === "string"
                    ? basicInfo.poDate
                    : format(new Date(basicInfo.poDate), "dd MMM yyyy")
                  : "N/A"}
              </div>
            </div>

            <div className="space-y-1">
              <div className="flex items-center gap-2 text-sm text-gray-500">
                <Truck className="h-4 w-4" />
                Channel
              </div>
              <Badge variant="outline">{basicInfo.channel}</Badge>
            </div>

            <div className="space-y-1">
              <div className="flex items-center gap-2 text-sm text-gray-500">
                <MapPin className="h-4 w-4" />
                Location
              </div>
              <div className="text-sm">{basicInfo.location}</div>
            </div>

            <div className="space-y-1">
              <div className="flex items-center gap-2 text-sm text-gray-500">
                <MapPin className="h-4 w-4" />
                Pickup Location
              </div>
              <div className="text-sm">{basicInfo.pickupLocation}</div>
            </div>

            <div className="space-y-1">
              <div className="flex items-center gap-2 text-sm text-gray-500">
                <FileText className="h-4 w-4" />
                PO Number
              </div>
              <div className="font-mono text-sm">{basicInfo.poNumber}</div>
            </div>

            <div className="space-y-1">
              <div className="flex items-center gap-2 text-sm text-gray-500">
                <Weight className="h-4 w-4" />
                Chargeable Weight
              </div>
              <div className="text-sm font-semibold">{basicInfo?.chargeableWeight?.toFixed(2)} kg</div>
            </div>

            <div className="space-y-1">
              <div className="flex items-center gap-2 text-sm text-gray-500">
                <DollarSign className="h-4 w-4" />
                Rate per KG
              </div>
              <div className="text-sm font-semibold">â‚¹{basicInfo?.ratePerKg?.toFixed(2)}</div>
            </div>
          </div>
        </CardContent>
      </Card>

      {/* Cost Calculations */}
      <Card>
        <CardHeader>
          <CardTitle className="flex items-center gap-2">
            <Calculator className="h-5 w-5" />
            Cost Calculations
          </CardTitle>
        </CardHeader>
        <CardContent className="space-y-6">
          {/* Freight Cost */}
          <div className="flex items-center justify-between p-4 bg-blue-50 dark:bg-blue-950 rounded-lg">
            <div>
              <div className="font-medium">Freight Cost</div>
              <div className="text-sm text-gray-600 dark:text-gray-400">
                {basicInfo.chargeableWeight?.toFixed(2)} kg Ã— â‚¹{basicInfo.ratePerKg?.toFixed(2)}
              </div>
            </div>
            <div className="text-lg font-bold text-blue-600">â‚¹{costs.frightCost?.toFixed(2)}</div>
          </div>

          {/* Final FOV */}
          <div className="flex items-center justify-between p-4 bg-green-50 dark:bg-green-950 rounded-lg">
            <div>
              <div className="font-medium">Final FOV</div>
              <div className="text-sm text-gray-600 dark:text-gray-400">
                Courier Type: {basicInfo.courierType} -
                {basicInfo.courierType === "Type A" && " Max(Updated PO Value Ã— 0.001, â‚¹100)"}
                {basicInfo.courierType === "Type B" && " Flat â‚¹100"}
                {basicInfo.courierType === "Type C" && " â‚¹0"}
                {!["Type A", "Type B", "Type C"].includes(basicInfo.courierType) &&
                  " No Courier type"}
              </div>
              <div className="text-xs text-gray-500 mt-1">
                Based on PO Value: â‚¹{basicInfo.updatedPoValue?.toFixed(2)}
              </div>
            </div>
            <div className="text-lg font-bold text-green-600">â‚¹{costs.finalFov?.toFixed(2)}</div>
          </div>

          {/* Docket Charges */}
          <div className="flex items-center justify-between p-4 bg-orange-50 dark:bg-orange-950 rounded-lg">
            <div>
              <div className="font-medium">Docket Charges</div>
              <div className="text-sm text-gray-600 dark:text-gray-400">
                {basicInfo.firstTransporter || "No transporter"} courier partner
              </div>
            </div>
            <div className="text-lg font-bold text-orange-600">â‚¹{costs.docketCharges?.toFixed(2)}</div>
          </div>

          {/* Appointment Charges */}
          <div className="flex items-center justify-between p-4 bg-purple-50 dark:bg-purple-950 rounded-lg">
            <div>
              <div className="font-medium flex items-center gap-2">
                <Clock className="h-4 w-4" />
                Appointment Charges
              </div>
              <div className="text-sm text-gray-600 dark:text-gray-400">
                {basicInfo.channel} Ã— {basicInfo.firstTransporter || "Default"}
              </div>
            </div>
            <div className="text-lg font-bold text-purple-600">â‚¹{costs.appointmentCharges?.toFixed(2)}</div>
          </div>

          {/* Miscellaneous Charges */}
          <div className="space-y-3">
            <div className="font-medium flex items-center gap-2">
              <Package className="h-4 w-4" />
              Miscellaneous Charges
            </div>
            <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
              {costs.miscCharges &&
                Object.entries(costs.miscCharges).map(([name, amount]) => (
                  <div key={name} className="flex justify-between items-center p-3 bg-gray-50 dark:bg-gray-800 rounded">
                    <span className="text-sm">{name}</span>
                    <span className="font-semibold">â‚¹{amount?.toFixed(2)}</span>
                  </div>
                ))}
            </div>
            <div className="flex justify-between items-center p-3 bg-gray-100 dark:bg-gray-700 rounded font-medium">
              <span>Total Miscellaneous</span>
              <span>â‚¹{costs.totalMiscCharges?.toFixed(2)}</span>
            </div>
          </div>

          <Separator />

          {/* Total Cost */}
          <div className="flex items-center justify-between p-6 bg-gradient-to-r from-indigo-50 to-purple-50 dark:from-indigo-950 dark:to-purple-950 rounded-lg border-2 border-indigo-200 dark:border-indigo-800">
            <div>
              <div className="text-xl font-bold">Total Logistics Cost</div>
              <div className="text-sm text-gray-600 dark:text-gray-400">Sum of all charges and fees</div>
            </div>
            <div className="text-3xl font-bold text-indigo-600 dark:text-indigo-400">
              â‚¹{costs.totalCost?.toFixed(2)}
            </div>
          </div>
        </CardContent>
      </Card>
    </div>
  )
}
