name: Deploy test application on ec2

on:
  # push:
  #   branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    env:
      NODE_VERSION: 20

    steps:
      # Checkout
      - name: Checkout repository
        uses: actions/checkout@v4

      # Setup Node
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm
          cache-dependency-path: |
            backend/package-lock.json
            frontend/package-lock.json

      # Build Backend
      - name: Install backend deps
        working-directory: backend
        run: npm ci

      # Build Frontend (Next.js)
      - name: Create frontend env file
        env:
          FRONTEND_ENV: ${{ secrets.FRONTEND_ENV }}
        run: |
          echo "$FRONTEND_ENV" > frontend/.env.local

      - name: Install frontend deps
        working-directory: frontend
        run: npm ci

      - name: Build frontend
        working-directory: frontend
        run: npm run build


      # Prepare SSH
      - name: Setup SSH
        env:
          SSH_PRIVATE_KEY: ${{ secrets.EC2_SSH_KEY }}
          EC2_HOST: ${{ secrets.EC2_HOST }}
        run: |
          mkdir -p ~/.ssh
          echo "$SSH_PRIVATE_KEY" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H "$EC2_HOST" >> ~/.ssh/known_hosts

      # Upload Backend
      - name: Deploy backend to EC2
        env:
          EC2_USER: ${{ secrets.EC2_USER }}
          EC2_HOST: ${{ secrets.EC2_HOST }}
        run: |
          rsync -az \
            backend/ \
            ${EC2_USER}@${EC2_HOST}:/home/${EC2_USER}/test_app/backend

      # Upload Frontend Build Only
      - name: Deploy frontend build to EC2
        env:
          EC2_USER: ${{ secrets.EC2_USER }}
          EC2_HOST: ${{ secrets.EC2_HOST }}
        run: |
          rsync -az \
            frontend/.next \
            frontend/public \
            frontend/package.json \
            ${EC2_USER}@${EC2_HOST}:/home/${EC2_USER}/test_app/frontend

      # Upload Environment Files
      - name: Upload env file
        env:
          EC2_USER: ${{ secrets.EC2_USER }}
          EC2_HOST: ${{ secrets.EC2_HOST }}
          BACKEND_ENV: ${{ secrets.BACKEND_ENV }}
          FRONTEND_ENV: ${{ secrets.FRONTEND_ENV }}
        run: |
          ssh -i ~/.ssh/id_rsa ${EC2_USER}@${EC2_HOST} << EOF
          set -e

          mkdir -p ~/test_app/backend

          cat << 'EOT' > ~/test_app/backend/.env
          $BACKEND_ENV
          EOT

          mkdir -p ~/test_app/frontend

          cat << 'EOT' > ~/test_app/frontend/.env.local
          $FRONTEND_ENV
          EOT

          EOF

      # Install prod deps + restart apps
      - name: Restart apps with PM2
        env:
          EC2_USER: ${{ secrets.EC2_USER }}
          EC2_HOST: ${{ secrets.EC2_HOST }}
        run: |
          ssh -i ~/.ssh/id_rsa ${EC2_USER}@${EC2_HOST} << 'EOF'
          set -euxo pipefail

          cd ~/test_app/backend
          npm ci --omit=dev

          cd ~/test_app

          # pm2 start ecosystem.config.js --only backend --env production || pm2 restart backend
          # pm2 start ecosystem.config.js --only frontend --env production || pm2 restart frontend

          # pm2 save
          # EOF
